
<script type="text/javascript">

$(function () {
    var seriesOptions = [],
        ids = <%= raw @ids %>,
        seriesCounter = 0,
        names    = <%= raw @names %>,
        c        = <%= raw @colors %>,
        title    = <%= raw @title %>,
        sp_id    = <%= raw @sp_graph_id %>;
        var base_url = window.location.origin;
        var adt_path = "/adt/api_get_adt_data/";
        var static_graph_path = "/category/api_get_sp_data/";
        
      
    /**
     * Create the chart when all data is loaded
     * @returns {undefined}
     */
    function createChart() {

        $(<%= @divId %>).highcharts('StockChart', {

            rangeSelector: {
                selected: 1
            },


            yAxis:[{
                labels: {
                    align: 'left',
                    x: -3
                },
                title: {formatter: function () {
                        return (this.value > 0 ? ' + ' : '') + this.value + '%';
                    }
                  },
                height: '40%',
                lineWidth: 2
            }, {

                  labels: {
                    align: 'left',
                    x: -3
                },
                //title: titleOptionsStatic,
                top: '50%',
                height: '50%',
                offset: 0,
                lineWidth: 2
            }],


            title: titleOptions,
            legend: {
                enabled: true, 
            },


            series: seriesOptions
        });
    }


     /***************  static graph fetching *************/

    $.getJSON(base_url + static_graph_path + sp_id,    function (data) {
    
        seriesOptions[0] = {
            type: 'candlestick',
            name: "S&P500",
            data: data,
        };


        /*************** graphs data **********************/

        $.each(ids, function (i, val) {

            //alert('http://www.highcharts.com/samples/data/jsonp.php?filename=' + name.toLowerCase() + '-c.json&callback=?');
            $.getJSON(base_url + adt_path + val,    function (data) {


                seriesOptions[i+1] = {
                    type: 'line',
                    name: name[i],
                    data: data,
                    color: c[i],
                    yAxis:1
                };

                // As we're loading the data asynchronously, we don't know what order it will arrive. So
                // we keep a counter and create the chart when all the data is loaded.
                seriesCounter += 1;

                if (seriesCounter === ids.length) {

                    titleOptions = {
                        text: title,
                        
                        style: {
                          color: '#333333',
                          font: '16px Arial',
                          fontWeight:'bold',
                         
                        }
                    };

                    createChart();
                }
            });
        });

    });
   
});

</script>

