

<script type="text/javascript">

$(function () {
    var seriesOptions = [];
    var ids = <%= raw @ids %>;
    var seriesCounter = 0;
    var names    = <%= raw @names %>;
    var c        = <%= raw @colors %>;
    var title    = <%= raw @title %>;
    var sp_id    = <%= raw @sp_graph_id %>;
    var base_url = window.location.origin;
    var adt_path = "/adt/api_get_adt_data/";
    var static_graph_path = "/category/api_get_sp_data/";
    
      //alert(<%= @divId%>);
    /**
     * Create the chart when all data is loaded
     * @returns {undefined}
     */
    function createChart() {

       window.chart = new Highcharts.StockChart({

            chart: {
                renderTo: "<%= @divId %>" 
            },
            navigator: {
                enabled: false
            },
            rangeSelector : {
                allButtonsEnabled: true,
                buttons: [{
                    type: 'month',
                    count: 1,
                    text: '1M',
                    dataGrouping: {
                        forced: true,
                        units: [['day', [1]]]
                    }
                }, {
                    type: 'month',
                    count: 3,
                    text: '3M',
                    dataGrouping: {
                        forced: true,
                        units: [['day', [1]]]
                    }
                },{
                    type: 'year',
                    count: 1,
                    text: '1Y',
                    dataGrouping: {
                        forced: true,
                        units: [['day', [1]]]
                    }
                }, {
                    type: 'year',
                    count: 2,
                    text: '2Y',
                    dataGrouping: {
                        forced: true,
                        units: [['day', [1]]]
                    }
                }, {
                    type: 'year',
                    count: 3,
                    text: '3Y',
                    dataGrouping: {
                        forced: true,
                        units: [['day', [1]]]
                    }
                }, {
                    type: 'year',
                    count: 4,
                    text: '4Y',
                    dataGrouping: {
                        forced: true,
                        units: [['day', [1]]]
                    }
                }],
                buttonTheme: {
                    width: 60
                },
                selected: 2
            },

            yAxis:[{
                labels: {
                    align: 'left',
                    x: -3
                },
                title: {formatter: function () {
                        return (this.value > 0 ? ' + ' : '') + this.value + '%';
                    }
                  },
                height: '50%',
                lineWidth: 2
            }, {

                  labels: {
                    align: 'left',
                    x: -3
                },
                //title: titleOptionsStatic,
                top: '60%',
                height: '40%',
                offset: 0,
                lineWidth: 2
            }],

            title: titleOptions,
            legend: {
                enabled: true, 
            },

            series: seriesOptions
        }, function(chart) {

            // apply the date pickers
            setTimeout(function() {
                $('input.highcharts-range-selector', $('#' + chart.options.chart.renderTo)).datepicker()
            }, 0)
        });

        // Set the datepicker's date format
        $.datepicker.setDefaults({
            dateFormat: 'yy-mm-dd',
            onSelect: function(dateText) {
                this.onchange();
                this.onblur();
            }
        });
    } 


    /***************  static graph fetching *************/

    $.getJSON(base_url + static_graph_path + sp_id,    function (data) {
       
        seriesOptions[0] = {
            type: 'candlestick',
            name: "S&P500",
            data: data,
            dataGrouping: {
                units: [ ['day', [1] ] ]
            }
        };


        /*************** graphs data **********************/

        $.each(ids, function (i, val) {

            //alert('http://www.highcharts.com/samples/data/jsonp.php?filename=' + name.toLowerCase() + '-c.json&callback=?');
            $.getJSON(base_url + adt_path + val,    function (data) {

                
                seriesOptions[i+1] = {
                    type: 'line',
                    name: names[i],
                    data: data,
                    color: c[i],
                    yAxis:1,
                    dataGrouping: {
                        units: [ ['day', [1] ] ]
                    }
                };

                // As we're loading the data asynchronously, we don't know what order it will arrive. So
                // we keep a counter and create the chart when all the data is loaded.
                seriesCounter += 1;

                if (seriesCounter === ids.length) {

                    titleOptions = {
                        text: title,
                        
                        style: {
                          color: '#333333',
                          font: '16px Arial',
                          fontWeight:'bold',
                         
                        }
                    };
                    
                    $('<%= "#" + @divId + "_processor" %>').hide();
                    createChart();
                }
            });
        });

    });
   
});
Highcharts.Scroller.prototype.drawHandle = function () {};
</script>



